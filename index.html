<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Php Web Authentication by obullo</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Php Web Authentication</h1>
      <h2 class="project-tagline">Php authentication with rich features.</h2>
      <a href="https://github.com/obullo/Auth" class="btn">View on GitHub</a>
      <a href="https://github.com/obullo/Auth/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/obullo/Auth/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h2>
<a id="php-web-authentication" class="anchor" href="#php-web-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Php Web Authentication</h2>

<p>Obullo Auth package is designed to ease the management of authorization in the medium and large-scale applications caching the user identities according to their session numbers with the help of cache drivers. Auth package aims to be a scalable solution using the authentication adapters written for various common scenarios and supports multifactor authentication.</p>

<h3>
<a id="installing-with-composer" class="anchor" href="#installing-with-composer" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installing with Composer</h3>

<pre><code>composer require obullo/auth
</code></pre>

<h3>
<a id="installing-demo-application" class="anchor" href="#installing-demo-application" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Installing Demo Application</h3>

<pre><code>git clone git@github.com:obullo/Auth-Demo.git auth-demo
</code></pre>

<p>To look over the real examples try to install demo application.</p>

<h3>
<a id="features" class="anchor" href="#features" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Features</h3>

<ul>
<li>Cachable Identities</li>
<li>Multifactor Authentication (MFA)</li>
<li>Adapters for varied behaviors</li>
<li>Ability to see the users opening sessions with different computers and terminate the sessions</li>
<li>Table classes for different databases</li>
<li>'Remember Me' feature</li>
</ul>

<h3>
<a id="mfa-feature" class="anchor" href="#mfa-feature" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>MFA Feature</h3>

<p>In login operations, if authorizing the users includes more than one step, it is called multiple authorization. The method Multi-Factor Authentication consists of a multi-layered structure. It provides a shield which the attackers cannot get through with several authentication methods. These methods may be like below ones:</p>

<ul>
<li>OTP</li>
<li>QR Code</li>
<li>Call</li>
<li>Sms</li>
</ul>

<p>MFA, multiple authorization method, has a second step which get users required to authenticate their identities unlike standard login functions. Even if an attacker has a user password, he cannot pass the authentication since he does not have a secure device authorized for MFA.  </p>

<ul>
<li>This feature is optional.</li>
</ul>

<h3>
<a id="flow-chart" class="anchor" href="#flow-chart" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Flow Chart</h3>

<p>The below diagram will give you a prior knowledge about how a user pass the authorization verification steps and how the server works:</p>

<p><img src="https://github.com/obullo/mfa/blob/master/flowchart.png?raw=true" alt="Authentication" title="Authentication"></p>

<p>As seen on schema, two users are at the issue as <kbd>Guest</kbd> and <kbd>User</kbd>. Guest is <kbd>unauthorized</kbd> and user is <kbd>authorized</kbd> on the service side.</p>

<p>According to the schema, as soon as the Guest clicks the login button, firstly the cache is queried and checked if the user has already had a permanent identity. If there are permanent authorization on the memory block, the user idendity is read from here. If not, the database is queried and retrieved identity card is  re-written into cache.</p>

<p><a name="configuration"></a></p>

<h3>
<a id="configuration" class="anchor" href="#configuration" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Configuration</h3>

<p>Authentication class works with <a href="http://container.thephpleague.com/">Php League Container</a> package by default.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">require_once</span> <span class="pl-s"><span class="pl-pds">"</span>vendor/autoload.php<span class="pl-pds">"</span></span>;</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c1">session_start</span>();</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$container</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">League\Container\</span><span class="pl-c1">Container</span>;</span>
<span class="pl-s1"><span class="pl-smi">$request</span> <span class="pl-k">=</span> <span class="pl-c1">Zend\Diactoros\</span><span class="pl-c1">ServerRequestFactory</span><span class="pl-k">::</span>fromGlobals();</span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>share(<span class="pl-s"><span class="pl-pds">'</span>request<span class="pl-pds">'</span></span>, <span class="pl-smi">$request</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>addServiceProvider(<span class="pl-s"><span class="pl-pds">'</span>ServiceProvider\Redis<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>addServiceProvider(<span class="pl-s"><span class="pl-pds">'</span>ServiceProvider\Database<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>addServiceProvider(<span class="pl-s"><span class="pl-pds">'</span>ServiceProvider\Authentication<span class="pl-pds">'</span></span>);</span></pre></div>

<p>All the configuration of the auth can be edited in the register method in the <kbd>classes/ServiceProvider/Authentication</kbd> class.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>share(<span class="pl-s"><span class="pl-pds">'</span>Auth.PASSWORD_COST<span class="pl-pds">'</span></span>, <span class="pl-c1">6</span>);</span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>share(<span class="pl-s"><span class="pl-pds">'</span>Auth.PASSWORD_ALGORITHM<span class="pl-pds">'</span></span>, <span class="pl-c1">PASSWORD_BCRYPT</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>share(<span class="pl-s"><span class="pl-pds">'</span>Auth:Storage<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Obullo\Auth\Storage\Redis<span class="pl-pds">'</span></span>)</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withArgument(<span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">'</span>redis:default<span class="pl-pds">'</span></span>))</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withArgument(<span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">'</span>request<span class="pl-pds">'</span></span>))</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setPermanentBlockLifetime<span class="pl-pds">'</span></span>, [<span class="pl-c1">3600</span>]) <span class="pl-c">// Should be same with app session lifetime.</span></span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setTemporaryBlockLifetime<span class="pl-pds">'</span></span>, [<span class="pl-c1">300</span>]);</span></pre></div>

<p><a name="adapters"></a></p>

<h3>
<a id="adapters" class="anchor" href="#adapters" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Adapters</h3>

<p>Identity verification adapters are interfaces adding flexibility to applications, which specify identity is verified with either a database or over a different protocol. The default interface is <kbd>Database</kbd> (It is used commonly for both RDBMS  and NoSQL  databases).  </p>

<p>It is possible that different adapters have different behaviors and options, however, some basic procedures are common among the identity verification adapters such as performing the queries for identity verification service and results returned by these queries. </p>

<p><a name="storages"></a></p>

<h3>
<a id="storages" class="anchor" href="#storages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Storages</h3>

<p>Storage caches the user identity while verifying the identity and prevents the application from losing performance not connecting to the database when user logs in again and again.</p>

<p>Supported Drivers</p>

<ul>
<li>Redis</li>
<li>Memcached</li>
</ul>

<p>Storages can be changed in the service configuration.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>share(<span class="pl-s"><span class="pl-pds">'</span>Auth:Storage<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Obullo\Auth\Storage\Memcached<span class="pl-pds">'</span></span>)</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withArgument(<span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">'</span>memcached:default<span class="pl-pds">'</span></span>))</span></pre></div>

<p>Also, you need to call your service provider from the mainpage.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>addServiceProvider(<span class="pl-s"><span class="pl-pds">'</span>ServiceProvider\Memcached<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>addServiceProvider(<span class="pl-s"><span class="pl-pds">'</span>ServiceProvider\Database<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>addServiceProvider(<span class="pl-s"><span class="pl-pds">'</span>ServiceProvider\Authentication<span class="pl-pds">'</span></span>);</span></pre></div>

<h3>
<a id="database" class="anchor" href="#database" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Database</h3>

<p>If you use a relational database like MySQL, run the below SQL code to create a table.</p>

<div class="highlight highlight-source-sql"><pre><span class="pl-k">CREATE</span> <span class="pl-k">DATABASE</span> <span class="pl-en">IF</span> NOT EXISTS test;

use test;

<span class="pl-k">CREATE</span> <span class="pl-k">TABLE</span> <span class="pl-en">IF</span> NOT EXISTS <span class="pl-s"><span class="pl-pds">`</span>users<span class="pl-pds">`</span></span> (
  <span class="pl-s"><span class="pl-pds">`</span>id<span class="pl-pds">`</span></span> <span class="pl-k">int</span>(<span class="pl-c1">11</span>) <span class="pl-k">NOT NULL</span> AUTO_INCREMENT,
  <span class="pl-s"><span class="pl-pds">`</span>username<span class="pl-pds">`</span></span> <span class="pl-k">varchar</span>(<span class="pl-c1">100</span>) <span class="pl-k">NOT NULL</span>,
  <span class="pl-s"><span class="pl-pds">`</span>password<span class="pl-pds">`</span></span> <span class="pl-k">varchar</span>(<span class="pl-c1">80</span>) <span class="pl-k">NOT NULL</span>,
  <span class="pl-s"><span class="pl-pds">`</span>remember_token<span class="pl-pds">`</span></span> <span class="pl-k">varchar</span>(<span class="pl-c1">64</span>) <span class="pl-k">NOT NULL</span>,
  <span class="pl-k">PRIMARY KEY</span> (<span class="pl-s"><span class="pl-pds">`</span>id<span class="pl-pds">`</span></span>),
  KEY <span class="pl-s"><span class="pl-pds">`</span>username<span class="pl-pds">`</span></span> (<span class="pl-s"><span class="pl-pds">`</span>username<span class="pl-pds">`</span></span>),
  KEY <span class="pl-s"><span class="pl-pds">`</span>remember_token<span class="pl-pds">`</span></span> (<span class="pl-s"><span class="pl-pds">`</span>remember_token<span class="pl-pds">`</span></span>)
) ENGINE<span class="pl-k">=</span>InnoDB  DEFAULT CHARSET<span class="pl-k">=</span>utf8;

<span class="pl-k">INSERT INTO</span> <span class="pl-s"><span class="pl-pds">`</span>users<span class="pl-pds">`</span></span> (<span class="pl-s"><span class="pl-pds">`</span>id<span class="pl-pds">`</span></span>, <span class="pl-s"><span class="pl-pds">`</span>username<span class="pl-pds">`</span></span>, <span class="pl-s"><span class="pl-pds">`</span>password<span class="pl-pds">`</span></span>, <span class="pl-s"><span class="pl-pds">`</span>remember_token<span class="pl-pds">`</span></span>) <span class="pl-k">VALUES</span> 
(<span class="pl-c1">1</span>, <span class="pl-s"><span class="pl-pds">'</span>user@example.com<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>$2y$06$6k9aYbbOiVnqgvksFR4zXO.kNBTXFt3cl8xhvZLWj4Qi/IpkYXeP.<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span><span class="pl-pds">'</span></span>);</pre></div>

<p>The name of the test user is <kbd><a href="mailto:user@example.com">user@example.com</a></kbd> and the password is <kbd>123456</kbd>.</p>

<h3>
<a id="auth-table" class="anchor" href="#auth-table" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Auth Table</h3>

<p>If you want to change the queries or want to use a NoSQL solution, you can replace the value <kbd>Obullo\Auth\Adapter\Table\Db</kbd> of the key Auth:Table with your table class from the Authentication service provider.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>share(<span class="pl-s"><span class="pl-pds">'</span>Auth:Table<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>My\Table\Db<span class="pl-pds">'</span></span>)</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withArgument(<span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">'</span>database:default<span class="pl-pds">'</span></span>))</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setColumns<span class="pl-pds">'</span></span>, [<span class="pl-c1">array</span>(<span class="pl-s"><span class="pl-pds">'</span>username<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>email<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>remember_token<span class="pl-pds">'</span></span>)])</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setTableName<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>users<span class="pl-pds">'</span></span>])</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setIdentityColumn<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>email<span class="pl-pds">'</span></span>])</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setPasswordColumn<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>])</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setRememberTokenColumn<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>remember_token<span class="pl-pds">'</span></span>]);</span></pre></div>

<p>An example for Mongo Db.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>share(<span class="pl-s"><span class="pl-pds">'</span>Auth:Table<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Obullo\Auth\Adapter\Database\Table\Mongo<span class="pl-pds">'</span></span>);</span></pre></div>

<h3>
<a id="login" class="anchor" href="#login" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Login</h3>

<p>The login operation is performed over the login method and this method returns an <kbd>AuthResult</kbd> object checking the results of the login.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$credentials</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Obullo\Auth\</span><span class="pl-c1">Credentials</span>;</span>
<span class="pl-s1"><span class="pl-smi">$credentials</span><span class="pl-k">-&gt;</span>setIdentityValue(<span class="pl-s"><span class="pl-pds">'</span>user@example.com<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$credentials</span><span class="pl-k">-&gt;</span>setPasswordValue(<span class="pl-s"><span class="pl-pds">'</span>123456<span class="pl-pds">'</span></span>);</span>
<span class="pl-s1"><span class="pl-smi">$credentials</span><span class="pl-k">-&gt;</span>setRememberMeValue(<span class="pl-c1">false</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-smi">$authAdapter</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Obullo\Auth\Adapter\</span><span class="pl-c1">Table</span>(<span class="pl-smi">$container</span>);</span>
<span class="pl-s1"><span class="pl-smi">$authResult</span>  <span class="pl-k">=</span> <span class="pl-smi">$authAdapter</span><span class="pl-k">-&gt;</span>authenticate(<span class="pl-smi">$credentials</span>);</span>
<span class="pl-s1"><span class="pl-smi">$authAdapter</span><span class="pl-k">-&gt;</span>regenerateSessionId(<span class="pl-c1">true</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-c1">false</span> <span class="pl-k">==</span> <span class="pl-smi">$authResult</span><span class="pl-k">-&gt;</span>isValid()) {</span>
<span class="pl-s1">    <span class="pl-c1">print_r</span>(<span class="pl-smi">$authResult</span><span class="pl-k">-&gt;</span>getMessages());</span>
<span class="pl-s1">} <span class="pl-k">else</span> {</span>
<span class="pl-s1">    <span class="pl-smi">$user</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Obullo\Auth\User\</span><span class="pl-c1">User</span>(<span class="pl-smi">$credentials</span>);</span>
<span class="pl-s1">    <span class="pl-smi">$user</span><span class="pl-k">-&gt;</span>setResultRow(<span class="pl-smi">$authResult</span><span class="pl-k">-&gt;</span>getResultRow());</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-smi">$identity</span> <span class="pl-k">=</span> <span class="pl-smi">$authAdapter</span><span class="pl-k">-&gt;</span>authorize(<span class="pl-smi">$user</span>); <span class="pl-c">// Authorize user;</span></span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c1">header</span>(<span class="pl-s"><span class="pl-pds">"</span>Location: /example/Restricted.php<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1">}</span></pre></div>

<p>The login success is checked with the method <kbd>AuthResult-&gt;isValid()</kbd> and if the login fails, all the returning error messages can be reached with the method getArray().</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$auhtResult</span><span class="pl-k">-&gt;</span>isValid()) {</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c">// Success</span></span>
<span class="pl-s1"></span>
<span class="pl-s1">} <span class="pl-k">else</span> {</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c">// Fail</span></span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c1">print_r</span>(<span class="pl-smi">$auhtResult</span><span class="pl-k">-&gt;</span>getArray());</span>
<span class="pl-s1">}</span></pre></div>

<p><strong>Note:</strong> Remember take a look at the example created in the <kbd>example</kbd> folder.</p>

<p><a name="login-error-results"></a></p>

<h3>
<a id="error-table" class="anchor" href="#error-table" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Error Table</h3>

<table>
    <thead>
        <tr>
            <th>Code</th>    
            <th>Constant</th>    
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>0</td>
            <td>AuthResult::FAILURE</td>
            <td>Failed general authorization verification</td>
        </tr>
        <tr>
            <td>-1</td>
            <td>AuthResult::FAILURE_IDENTITY_AMBIGUOUS</td>
            <td>Failed authorization verification due to indefinite identity(Shows that the query results includes more than one identity).</td>
        </tr>
        <tr>
            <td>-2</td>
            <td>AuthResult::FAILURE_CREDENTIAL_INVALID</td>
            <td>Shows that invalid credentials are entered</td>
        </tr>
        <tr>
            <td>1</td>
            <td>AuthResult::SUCCESS</td>
            <td>Successful authorization verification</td>
        </tr>

    </tbody>
</table>

<p><a name="identities"></a></p>

<h3>
<a id="identities" class="anchor" href="#identities" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Identities</h3>

<p>Identity class executes <kbd>read</kbd> and <kbd>write</kbd> operations of the user identity. The set method is used to save a value to the identity:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>set(<span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>my_value<span class="pl-pds">'</span></span>);</span></pre></div>

<p>The get method is used to retrieve the value from the credentials: </p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">echo</span> <span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>);  <span class="pl-c">// my_value</span></span></pre></div>

<p>The below method is used to get all the credentials:</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">print_r</span>(<span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>getArray());</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-c">/*</span></span>
<span class="pl-s1"><span class="pl-c">Array</span></span>
<span class="pl-s1"><span class="pl-c">(</span></span>
<span class="pl-s1"><span class="pl-c">    [__isAuthenticated] =&gt; 1</span></span>
<span class="pl-s1"><span class="pl-c">    [__isTemporary] =&gt; 0</span></span>
<span class="pl-s1"><span class="pl-c">    [__rememberMe] =&gt; 0</span></span>
<span class="pl-s1"><span class="pl-c">    [__time] =&gt; 1470858670.5284</span></span>
<span class="pl-s1"><span class="pl-c">    [__ip] =&gt; 127.0.0.1</span></span>
<span class="pl-s1"><span class="pl-c">    [__agent] =&gt; Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:47.0) Gecko/20100101 Firefox/47.0</span></span>
<span class="pl-s1"><span class="pl-c">    [__lastActivity] =&gt; 1470419173</span></span>
<span class="pl-s1"><span class="pl-c">    [id] =&gt; 1</span></span>
<span class="pl-s1"><span class="pl-c">    [password] =&gt; $2y$10$0ICQkMUZBEAUMuyRYDlXe.PaOT4LGlbj6lUWXg6w3GCOMbZLzM7bm</span></span>
<span class="pl-s1"><span class="pl-c">    [remember_token] =&gt; bqhiKfIWETlSRo7wB2UByb1Oyo2fpb86</span></span>
<span class="pl-s1"><span class="pl-c">    [username] =&gt; user@example.com</span></span>
<span class="pl-s1"><span class="pl-c">)</span></span>
<span class="pl-s1"><span class="pl-c">*/</span></span></pre></div>

<p><a name="identity-keys"></a></p>

<h3>
<a id="identity-keys" class="anchor" href="#identity-keys" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Identity Keys</h3>

<table>
    <thead>
        <tr>
            <th>Key</th>    
            <th>Description</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>__isAuthenticated</td>
            <td>If the user is authorized this key contains the value <kbd>1</kbd>, otherwise <kbd>0</kbd>.</td>
        </tr>
        <tr>
            <td>__isTemporary</td>
            <td>It is used for the feature of authorization verification.</td>
        </tr>
        <tr>
            <td>__rememberMe</td>
            <td>If the user has used this feature when login, this contains <kbd>1</kbd>, otherwise <kbd>0</kbd>.</td>
        </tr>
        <tr>
            <td>__time</td>
            <td>Time when the identity is created. It is saved in the format of Unix microtime().</td>
        </tr>
        <tr>
            <td>__ip</td>
            <td>The IP address which the user logins lastly.</td>
        </tr>
        <tr>
            <td>__agent</td>
            <td>The browser and operation system information that the user has</td>
        </tr>
        <tr>
            <td>__lastActivity</td>
            <td>The time of the last activity.</td>
        </tr>
    </tbody>
</table>

<h3>
<a id="password-rehash" class="anchor" href="#password-rehash" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Password Rehash</h3>

<p>If login has failed, the password rehash is decided with the method  <kbd>$authAdapter-&gt;passwordNeedsRehash()</kbd>. This method returns the new hash value of the password using the <kbd>password_needs_rehash()</kbd> and <kbd>password_hash()</kbd> methods of php.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$hash</span> <span class="pl-k">=</span> <span class="pl-smi">$authAdapter</span><span class="pl-k">-&gt;</span>passwordNeedsRehash()) {</span>
<span class="pl-s1">    <span class="pl-c">// UPDATE `users` WHERE email = `$email` SET password = "$hash";</span></span>
<span class="pl-s1">}</span></pre></div>

<p>If method does not return false, the user password should be replace in db with the returned hash.</p>

<h3>
<a id="adapter" class="anchor" href="#adapter" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Adapter</h3>

<hr>

<h4>
<a id="authadapter-authenticatecredentials-credentials" class="anchor" href="#authadapter-authenticatecredentials-credentials" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authAdapter-&gt;authenticate(Credentials $credentials);</h4>

<p>Returns to the AuthResult object after verifying the authorization with the user information.</p>

<h4>
<a id="authadapter-regeneratesessionidtrue" class="anchor" href="#authadapter-regeneratesessionidtrue" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authAdapter-&gt;regenerateSessionId(true);</h4>

<p>Specifies if the session id will be re-created or not after login.</p>

<h4>
<a id="authadapter-validatecredentialscredentials-credentials" class="anchor" href="#authadapter-validatecredentialscredentials-credentials" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authAdapter-&gt;validateCredentials(Credentials $credentials);</h4>

<p>Verifies the credentials without authorizing the user and returns true or false accordingly.</p>

<h4>
<a id="authadapter-authorizeuser-user" class="anchor" href="#authadapter-authorizeuser-user" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authAdapter-&gt;authorize(User $user);</h4>

<p>Used to authorize guest user whose credentials has already been verified with user object.</p>

<p><a name="identity-method-reference"></a></p>

<h3>
<a id="identity" class="anchor" href="#identity" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Identity</h3>

<hr>

<h4>
<a id="identity-check" class="anchor" href="#identity-check" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;check();</h4>

<p>Returns <kbd>true</kbd> if the user passes authorization verification, otherwise <kbd>false</kbd>.</p>

<h4>
<a id="identity-guest" class="anchor" href="#identity-guest" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;guest();</h4>

<p>Checks if the user is a guest, whose authorization has not been verified. If guest, returns <kbd>true</kbd>, otherwise <kbd>false</kbd>.</p>

<h4>
<a id="identity-setkey-value" class="anchor" href="#identity-setkey-value" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;set($key, $value);</h4>

<p>Sets a value to the key entered to the idendity array.</p>

<h4>
<a id="identity-getkey" class="anchor" href="#identity-getkey" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;get($key);</h4>

<p>Returns the value of the key entered from the identity array. Returns fakse if no key is found.</p>

<h4>
<a id="identity-removekey" class="anchor" href="#identity-removekey" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;remove($key);</h4>

<p>Removes the existent key from the idendity array.</p>

<h4>
<a id="identity-expirettl" class="anchor" href="#identity-expirettl" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;expire($ttl);</h4>

<p>Sets the expiring time to the __expire key in order for user idendity to be expired when the time passes.  </p>

<h4>
<a id="identity-isexpired" class="anchor" href="#identity-isexpired" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;isExpired();</h4>

<p>Returns <kbd>true</kbd> if the time set by the method expire() is expired and returns <kbd>false</kbd> otherwise. This method can be used on the Http Auth Layer as below: </p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>isExpired()) {</span>
<span class="pl-s1">    <span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>destroy();    </span>
<span class="pl-s1">}</span></pre></div>

<h4>
<a id="identity-maketemporaryexpire--300" class="anchor" href="#identity-maketemporaryexpire--300" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;makeTemporary($expire = 300);</h4>

<p>Makes the user idendity which has logged in successfully temporary according to the time specified for the multifactor authentication. When expired, idendity is removed from the storage.</p>

<h4>
<a id="identity-makepermanent" class="anchor" href="#identity-makepermanent" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;makePermanent();</h4>

<p>Makes the temporary identity of the user who has passed the multifactor authentication permanent. When the permanent idendity time(3600 seconds by default) expires, the database is re-queried and the idendity saves into memory. </p>

<h4>
<a id="identity-istemporary" class="anchor" href="#identity-istemporary" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;isTemporary();</h4>

<p>Shows either user idendity is temporary or permanent in multifactor authentication, returns <kbd>1</kbd> if temporary, otherwise <kbd>0</kbd>. </p>

<h4>
<a id="identity-updatetemporarystring-key-mixed-val" class="anchor" href="#identity-updatetemporarystring-key-mixed-val" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;updateTemporary(string $key, mixed $val);</h4>

<p>Enables to update the temporary credentials in multifactor authentication.</p>

<h4>
<a id="identity-logout" class="anchor" href="#identity-logout" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;logout();</h4>

<p>Logs out while updating the <kbd>isAuthenticated</kbd> key in the cache with <kbd>0</kbd>. This method does not completely removes the user idendity from the cache, it just saves the user as if he has ended the session. Thanks to caching, when the user logs in again within <kbd>3600</kbd> seconds, <kbd>isAuthenticated</kbd> value is updated to <kbd>1</kbd> and the database query is prevented.</p>

<h4>
<a id="identity-destroy" class="anchor" href="#identity-destroy" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;destroy();</h4>

<p>Destroys the user idendity completely.</p>

<h4>
<a id="identity-forgetme" class="anchor" href="#identity-forgetme" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;forgetMe();</h4>

<p>Removes the cookie 'remember me' from the browser.</p>

<h4>
<a id="identity-refreshremembertoken" class="anchor" href="#identity-refreshremembertoken" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;refreshRememberToken();</h4>

<p>Refreshes the cookie 'rememeber me' and saves into database and cookie again.</p>

<h4>
<a id="identity-getidentifier" class="anchor" href="#identity-getidentifier" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;getIdentifier();</h4>

<p>Returns the identifier of the user. It is generally <kbd>username</kbd> or <kbd>email</kbd>.</p>

<h4>
<a id="identity-getpassword" class="anchor" href="#identity-getpassword" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;getPassword();</h4>

<p>Returns the hashed password of the user.</p>

<h4>
<a id="identity-getrememberme" class="anchor" href="#identity-getrememberme" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;getRememberMe();</h4>

<p>Returns <kbd>1</kbd> if the user uses the feature 'remember me', otherwise returns <kbd>0</kbd>.</p>

<h4>
<a id="identity-gettime" class="anchor" href="#identity-gettime" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;getTime();</h4>

<p>Returns the first creation time of the idendity (Unix microtime).</p>

<h4>
<a id="identity-getrememberme-1" class="anchor" href="#identity-getrememberme-1" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;getRememberMe();</h4>

<p>If the user has used the feature 'remember me' results <kbd>1</kbd>, otherwise returns <kbd>0</kbd>.</p>

<h4>
<a id="identity-getremembertoken" class="anchor" href="#identity-getremembertoken" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;getRememberToken();</h4>

<p>Returns the value of the cookie 'rememeber me'.</p>

<h4>
<a id="identity-getloginid" class="anchor" href="#identity-getloginid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;getLoginId();</h4>

<p>One or more sessions are numbered and returns returns the session number of the user logged in, otherwise returns false.</p>

<h4>
<a id="identity-getarray" class="anchor" href="#identity-getarray" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$identity-&gt;getArray()</h4>

<p>Returns all the credentials within an array.</p>

<h3>
<a id="storage" class="anchor" href="#storage" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Storage</h3>

<hr>

<h4>
<a id="storage-getusersessions" class="anchor" href="#storage-getusersessions" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$storage-&gt;getUserSessions();</h4>

<p>If user has one or more sessions, returns these sessions within an array.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$sessions</span> <span class="pl-k">=</span> <span class="pl-smi">$storage</span><span class="pl-k">-&gt;</span>getUserSessions();</span></pre></div>

<p>If a user logs in with two different browsers, the output of this method is similar to below. </p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c1">print_r</span>(<span class="pl-smi">$sesssion</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1"><span class="pl-k">Array</span></span>
<span class="pl-s1">(</span>
<span class="pl-s1">    [048<span class="pl-c1">f7b509a22800088f1cd8c1cc04b96</span>] <span class="pl-k">=&gt;</span> <span class="pl-k">Array</span></span>
<span class="pl-s1">        (</span>
<span class="pl-s1">            [<span class="pl-c1">__isAuthenticated</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span></span>
<span class="pl-s1">            [<span class="pl-c1">__time</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">1470858670.5284</span></span>
<span class="pl-s1">            [<span class="pl-c1">__id</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">user</span><span class="pl-k">@</span><span class="pl-c1">example</span><span class="pl-k">.</span><span class="pl-c1">com</span></span>
<span class="pl-s1">            [<span class="pl-c1">__key</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">Auth</span>:<span class="pl-c1">user</span><span class="pl-k">@</span><span class="pl-c1">example</span><span class="pl-k">.</span><span class="pl-c1">com</span>:048<span class="pl-c1">f7b509a22800088f1cd8c1cc04b96</span></span>
<span class="pl-s1">            [<span class="pl-c1">__agent</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">Mozilla</span><span class="pl-k">/</span><span class="pl-c1">5.0</span> (<span class="pl-c1">X11</span>; <span class="pl-c1">Linux</span> <span class="pl-c1">x86_64</span>) <span class="pl-c1">AppleWebKit</span><span class="pl-k">/</span><span class="pl-c1">537.36</span> (<span class="pl-c1">KHTML</span>,<span class="pl-k">..</span></span>
<span class="pl-s1">            [<span class="pl-c1">__ip</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">212.124</span><span class="pl-k">.</span><span class="pl-c1">16.1</span>,</span>
<span class="pl-s1">            [<span class="pl-c1">__lastActivity</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">1470419674</span></span>
<span class="pl-s1">        )</span>
<span class="pl-s1"></span>
<span class="pl-s1">    [1<span class="pl-c1">dd468dbea32e8ed6f58cb00b40af76c</span>] <span class="pl-k">=&gt;</span> <span class="pl-k">Array</span></span>
<span class="pl-s1">        (</span>
<span class="pl-s1">            [<span class="pl-c1">__isAuthenticated</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">1</span></span>
<span class="pl-s1">            [<span class="pl-c1">__time</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">1470858670.6000</span></span>
<span class="pl-s1">            [<span class="pl-c1">__id</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">user</span><span class="pl-k">@</span><span class="pl-c1">example</span><span class="pl-k">.</span><span class="pl-c1">com</span></span>
<span class="pl-s1">            [<span class="pl-c1">__key</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">Auth</span>:<span class="pl-c1">user</span><span class="pl-k">@</span><span class="pl-c1">example</span><span class="pl-k">.</span><span class="pl-c1">com</span>:1<span class="pl-c1">dd468dbea32e8ed6f58cb00b40af76c</span></span>
<span class="pl-s1">            [<span class="pl-c1">__agent</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">Mozilla</span><span class="pl-k">/</span><span class="pl-c1">5.0</span> (<span class="pl-c1">X11</span>; <span class="pl-c1">Ubuntu</span>; <span class="pl-c1">Linux</span> <span class="pl-c1">x86_64</span>; <span class="pl-c1">rv</span>:<span class="pl-c1">47.0</span>) <span class="pl-c1">Gecko</span><span class="pl-k">/</span><span class="pl-c1">20100101</span> <span class="pl-c1">Firefox</span><span class="pl-k">/</span><span class="pl-c1">47.0</span></span>
<span class="pl-s1">            [<span class="pl-c1">__ip</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">88.169</span><span class="pl-k">.</span><span class="pl-c1">1.7</span>,</span>
<span class="pl-s1">            [<span class="pl-c1">__lastActivity</span>] <span class="pl-k">=&gt;</span> <span class="pl-c1">1470419665</span></span>
<span class="pl-s1">        )</span>
<span class="pl-s1">);</span></pre></div>

<h4>
<a id="storage-killsessionloginid" class="anchor" href="#storage-killsessionloginid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$storage-&gt;killSession($loginID);</h4>

<p>Terminates the user session according to session id.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$storage</span><span class="pl-k">-&gt;</span>killSession(<span class="pl-s"><span class="pl-pds">"</span>1dd468dbea32e8ed6f58cb00b40af76c<span class="pl-pds">"</span></span>);</span></pre></div>

<p>In the previous example, when login ID belonging to Firefox browser value is sent to this method, the session on the Firefox browser is terminated.</p>

<p><a name="authResult-reference"></a></p>

<h3>
<a id="authresult" class="anchor" href="#authresult" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>AuthResult</h3>

<hr>

<h4>
<a id="authresult-isvalid" class="anchor" href="#authresult-isvalid" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authResult-&gt;isValid();</h4>

<p>Returns <kbd>true</kbd> if the error code returning from the method login attempt greater than <kbd>0</kbd>, otherwise <kbd>false</kbd>. Successfull login operations returns the error code <kbd>1</kbd> and the other situations returns negative values.</p>

<h4>
<a id="authresult-getcode" class="anchor" href="#authresult-getcode" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authResult-&gt;getCode();</h4>

<p>Returns the error code after login attempt.</p>

<h4>
<a id="authresult-getidentifier" class="anchor" href="#authresult-getidentifier" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authResult-&gt;getIdentifier();</h4>

<p>Returns the credentials like id, username, email after login attempt.</p>

<h4>
<a id="authresult-getmessages" class="anchor" href="#authresult-getmessages" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authResult-&gt;getMessages();</h4>

<p>Returns the error messages after the login attempt.</p>

<h4>
<a id="authresult-setcodeint-code" class="anchor" href="#authresult-setcodeint-code" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authResult-&gt;setCode(int $code);</h4>

<p>Sets an error code to default result from the login attempt.</p>

<h4>
<a id="authresult-setmessagestring-message" class="anchor" href="#authresult-setmessagestring-message" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authResult-&gt;setMessage(string $message);</h4>

<p>Sets error messages to results returning from the login attempt.</p>

<h4>
<a id="authresult-getarray" class="anchor" href="#authresult-getarray" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authResult-&gt;getArray();</h4>

<p>Returns all the results in an array from the login attempt.</p>

<h4>
<a id="authresult-getresultrow" class="anchor" href="#authresult-getresultrow" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>$authResult-&gt;getResultRow();</h4>

<p>Returns the valid database adapter after the login attempt  according to query result either from database or cache if it exists.  </p>

<h3>
<a id="recall-recaller" class="anchor" href="#recall-recaller" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Recall (Recaller)</h3>

<p>If the user has already had a cookie 'remember me', the user can be authorized without entering the user information using the recaller function.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$token</span> <span class="pl-k">=</span> <span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>hasRecallerCookie()) {</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-smi">$recaller</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Obullo\Auth\</span><span class="pl-c1">Recaller</span>(<span class="pl-smi">$container</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-k">if</span> (<span class="pl-smi">$resultRowArray</span> <span class="pl-k">=</span> <span class="pl-smi">$recaller</span><span class="pl-k">-&gt;</span>recallUser(<span class="pl-smi">$token</span>)) {</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-smi">$credentials</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Obullo\Auth\User\</span><span class="pl-c1">Credentials</span>;</span>
<span class="pl-s1">        <span class="pl-smi">$credentials</span><span class="pl-k">-&gt;</span>setIdentityValue(<span class="pl-smi">$resultRowArray</span>[<span class="pl-s"><span class="pl-pds">'</span>email<span class="pl-pds">'</span></span>]);</span>
<span class="pl-s1">        <span class="pl-smi">$credentials</span><span class="pl-k">-&gt;</span>setPasswordValue(<span class="pl-smi">$resultRowArray</span>[<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>]);</span>
<span class="pl-s1">        <span class="pl-smi">$credentials</span><span class="pl-k">-&gt;</span>setRememberMeValue(<span class="pl-c1">true</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-smi">$user</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Obullo\Auth\User\</span><span class="pl-c1">User</span>(<span class="pl-smi">$credentials</span>);</span>
<span class="pl-s1">        <span class="pl-smi">$user</span><span class="pl-k">-&gt;</span>setResultRow(<span class="pl-smi">$resultRowArray</span>);</span>
<span class="pl-s1"></span>
<span class="pl-s1">        <span class="pl-smi">$authAdapter</span> <span class="pl-k">=</span> <span class="pl-k">new</span> <span class="pl-c1">Obullo\Auth\Adapter\</span><span class="pl-c1">Table</span>(<span class="pl-smi">$container</span>);</span>
<span class="pl-s1">        <span class="pl-smi">$authAdapter</span><span class="pl-k">-&gt;</span>authorize(<span class="pl-smi">$user</span>);</span>
<span class="pl-s1">        <span class="pl-smi">$authAdapter</span><span class="pl-k">-&gt;</span>regenerateSessionId(<span class="pl-c1">true</span>);</span>
<span class="pl-s1">    }</span>
<span class="pl-s1">}</span>
<span class="pl-s1"></span></pre></div>

<h3>
<a id="multifactor-authentication" class="anchor" href="#multifactor-authentication" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Multifactor Authentication</h3>

<p>Multifactor authentication makes the identity confirmation easier with the methods <b>OTP</b>, <b>Çağrı</b>, <b>Sms</b> or <b>QRCode</b> after a user logs in.</p>

<p>After a successful login, the user identity is cached permanently(3600 seconds by default). If the user is wanted to be approved,  permanent identities must be become temporary with the method <kbd>$identity-&gt;makeTemporary()</kbd> (300 seconds by default). A temporary idendity expires within 300 seconds itself. </p>

<p>In multifactor authentication, after user logs in,</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>makeTemporary(<span class="pl-c1">300</span>);</span></pre></div>

<p>using the method above, user idendity is made temporary and user cannot log in. The user must be sent verification code to approve his temporary idendity.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-k">if</span> (<span class="pl-smi">$authResult</span><span class="pl-k">-&gt;</span>isValid()) {</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>makeTemporary();</span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c">// Send verification code to user</span></span>
<span class="pl-s1"></span>
<span class="pl-s1">    <span class="pl-c1">header</span>(<span class="pl-s"><span class="pl-pds">"</span>Location: /example/Verify.php<span class="pl-pds">"</span></span>);</span>
<span class="pl-s1">}</span></pre></div>

<p>If verified, the temporary idendity must be set as permanent with the method <kbd>$identity-&gt;makePermanent()</kbd>. A permanent idendity means the user has successfully logged in.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$identity</span><span class="pl-k">-&gt;</span>makePermanent();</span></pre></div>

<p>If multifactor authentication is not used, system saves all identities as <kbd>permanent</kbd>.</p>

<h3>
<a id="mongo-table-driver" class="anchor" href="#mongo-table-driver" aria-hidden="true"><span aria-hidden="true" class="octicon octicon-link"></span></a>Mongo Table Driver</h3>

<p>If you want to use Mongo table driver, add the Mongo service provider from the commong file. Remember updating the connection information in the service provider.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-c">// $container-&gt;addServiceProvider('ServiceProvider\Database');</span></span>
<span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>addServiceProvider(<span class="pl-s"><span class="pl-pds">'</span>ServiceProvider\Mongo<span class="pl-pds">'</span></span>);</span></pre></div>

<p>Send the first argument in the authentication service as below.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">container</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">'</span>mongo:default<span class="pl-pds">'</span></span>)<span class="pl-k">-&gt;</span>selectDB(<span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>);</span></pre></div>

<p>The part needing to be changed in the service provider should be like below.</p>

<div class="highlight highlight-text-html-php"><pre><span class="pl-s1"><span class="pl-smi">$container</span><span class="pl-k">-&gt;</span>share(<span class="pl-s"><span class="pl-pds">'</span>Auth:Table<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>Obullo\Auth\Adapter\Table\Mongo<span class="pl-pds">'</span></span>)</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withArgument(<span class="pl-smi">$this</span><span class="pl-k">-&gt;</span><span class="pl-smi">container</span><span class="pl-k">-&gt;</span>get(<span class="pl-s"><span class="pl-pds">'</span>mongo:default<span class="pl-pds">'</span></span>)<span class="pl-k">-&gt;</span>selectDB(<span class="pl-s"><span class="pl-pds">'</span>test<span class="pl-pds">'</span></span>))</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setColumns<span class="pl-pds">'</span></span>, [<span class="pl-c1">array</span>(<span class="pl-s"><span class="pl-pds">'</span>username<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>email<span class="pl-pds">'</span></span>, <span class="pl-s"><span class="pl-pds">'</span>remember_token<span class="pl-pds">'</span></span>)])</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setTableName<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>users<span class="pl-pds">'</span></span>])</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setIdentityColumn<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>email<span class="pl-pds">'</span></span>])</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setPasswordColumn<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>password<span class="pl-pds">'</span></span>])</span>
<span class="pl-s1">    <span class="pl-k">-&gt;</span>withMethodCall(<span class="pl-s"><span class="pl-pds">'</span>setRememberTokenColumn<span class="pl-pds">'</span></span>, [<span class="pl-s"><span class="pl-pds">'</span>remember_token<span class="pl-pds">'</span></span>]);</span></pre></div>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/obullo/Auth">Php Web Authentication</a> is maintained by <a href="https://github.com/obullo">obullo</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>
